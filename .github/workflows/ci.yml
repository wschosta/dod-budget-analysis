# DoD Budget CI Workflow
#
# Runs on every push and pull request to main.
# Matrix: Python 3.11 and 3.12.
#
# Test groups (separated for easy failure diagnosis):
#   1. Lint + type check
#   2. Unit tests — utilities, patterns, config, validation, query builders
#   3. API tests — endpoints, models, search, download, rate limiting, PE
#   4. Frontend tests — routes, helpers, GUI features, fixes, accessibility
#   5. Data pipeline tests — build, enrichment, schema, pipeline, PDF
#   6. Performance tests — load, benchmarks, optimization
#   7. GUI tracker tests (tkinter, requires Xvfb)
#   8. Operational tests — refresh workflow, scheduled download
#   9. Custom optimization runner + benchmarks
#  10. Git workflow tests
#  11. Docker build validation

name: CI

on:
  push:
    branches: [main, develop, "claude/**", "refactor/**"]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: "Test (Python ${{ matrix.python-version }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install system dependencies (tkinter + Xvfb for GUI tests)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3-tk xvfb

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff pytest pytest-cov mypy pyyaml fpdf2 beautifulsoup4 openpyxl pdfplumber

      - name: Lint with ruff
        run: |
          ruff check . --select=E,W,F --ignore=E501 --exclude=DoD_Budget_Documents
        continue-on-error: true

      - name: Type check with mypy
        run: |
          mypy api/ utils/ downloader/ pipeline/ --ignore-missing-imports --no-error-summary
        continue-on-error: true

      # ── Unit tests: utilities, patterns, config, validation ──────────────
      - name: "Unit tests: utilities & patterns"
        run: |
          python -m pytest \
            tests/test_shared_group/test_common_utils.py \
            tests/test_shared_group/test_strings_edge_cases.py \
            tests/test_shared_group/test_patterns.py \
            tests/test_shared_group/test_formatting.py \
            tests/test_shared_group/test_cache_utils.py \
            tests/test_shared_group/test_database_utils.py \
            tests/test_shared_group/test_utils.py \
            tests/test_shared_group/test_utils_coverage.py \
            tests/test_shared_group/test_http_utils.py \
            tests/test_shared_group/test_progress_coverage.py \
            -v --tb=short

      - name: "Unit tests: config & validation"
        run: |
          python -m pytest \
            tests/test_shared_group/test_config_classes.py \
            tests/test_pipeline_group/test_validation.py \
            tests/test_shared_group/test_validation_classes.py \
            tests/test_pipeline_group/test_validate_budget_db.py \
            -v --tb=short

      - name: "Unit tests: query builders"
        run: |
          python -m pytest \
            tests/test_shared_group/test_query_builders.py \
            -v --tb=short

      # ── API tests: endpoints, models, search, download ──────────────────
      - name: "API tests: endpoints & models"
        run: |
          python -m pytest \
            tests/test_web_group/test_api.py \
            tests/test_web_group/test_api_models.py \
            tests/test_web_group/test_api_database.py \
            tests/test_web_group/test_api_search_snippet.py \
            tests/test_web_group/test_app_factory.py \
            tests/test_web_group/test_budget_lines_endpoint.py \
            tests/test_web_group/test_search_endpoint.py \
            tests/test_web_group/test_rate_limiter.py \
            tests/test_web_group/test_pe_endpoint.py \
            -v --tb=short

      - name: "API tests: download, charts & search"
        run: |
          python -m pytest \
            tests/test_web_group/test_download.py \
            tests/test_web_group/test_charts_data.py \
            tests/test_web_group/test_reference_aggregation.py \
            tests/test_pipeline_group/test_search.py \
            tests/test_pipeline_group/test_search_extended.py \
            -v --tb=short

      # ── Frontend tests: routes, helpers, GUI, accessibility ─────────────
      - name: "Frontend tests: routes & helpers"
        run: |
          python -m pytest \
            tests/test_web_group/test_frontend_routes.py \
            tests/test_web_group/test_frontend_helpers.py \
            tests/test_web_group/test_gui_features.py \
            tests/test_web_group/test_gui_fixes.py \
            tests/test_web_group/test_accessibility.py \
            tests/test_pipeline_group/test_gui_eta.py \
            -v --tb=short

      # ── Data pipeline tests ─────────────────────────────────────────────
      - name: "Pipeline tests: build, enrichment, schema"
        run: |
          python -m pytest \
            tests/test_pipeline_group/test_build_integration.py \
            tests/test_pipeline_group/test_schema_design.py \
            tests/test_pipeline_group/test_enrich_budget_db.py \
            tests/test_pipeline_group/test_checkpoint.py \
            tests/test_pipeline_group/test_exhibit_inventory.py \
            tests/test_pipeline_group/test_exhibit_audit.py \
            tests/test_pipeline_group/test_exhibit_catalog.py \
            tests/test_pipeline_group/test_parsing.py \
            tests/test_pipeline_group/test_manifest.py \
            tests/test_pipeline_group/test_backfill.py \
            tests/test_pipeline_group/test_fixture_integration.py \
            tests/test_pipeline_group/test_pdf_quality_audit.py \
            tests/test_pipeline_group/test_pdf_sections.py \
            -v --tb=short

      - name: "Pipeline tests: full pipeline integration"
        continue-on-error: true
        run: |
          python -m pytest tests/test_pipeline_group/test_pipeline.py -v --tb=short

      # ── Performance & optimization tests ────────────────────────────────
      - name: "Performance & optimization tests"
        run: |
          python -m pytest \
            tests/test_shared_group/test_performance.py \
            tests/test_shared_group/test_optimizations.py \
            tests/test_shared_group/test_optimization.py \
            -v --tb=short

      # ── Code quality & pre-commit checks ────────────────────────────────
      - name: "Pre-commit quality checks"
        run: |
          python -m pytest \
            tests/test_shared_group/test_precommit_checks.py \
            tests/test_shared_group/test_precommit_hook.py \
            -v --tb=short

      # ── Remaining tests (BEAR, TIGER, LION, etc.) ──────────────────────
      - name: "Advanced tests: BEAR, TIGER & LION groups"
        continue-on-error: true
        run: |
          python -m pytest \
            tests/test_pipeline_group/test_bear_dynamic_schema.py \
            tests/test_pipeline_group/test_bear_historical_compat.py \
            tests/test_pipeline_group/test_bear_migration.py \
            tests/test_web_group/test_bear_docker.py \
            tests/test_pipeline_group/test_bear_refresh_e2e.py \
            tests/test_pipeline_group/test_bear_validation_integration.py \
            tests/test_pipeline_group/test_bear_load.py \
            tests/test_web_group/test_tiger_performance.py \
            tests/test_web_group/test_tiger_caching.py \
            tests/test_web_group/test_tiger_feedback.py \
            tests/test_shared_group/test_tiger_validation.py \
            tests/test_pipeline_group/test_lion_db_integrity.py \
            tests/test_pipeline_group/test_reconciliation.py \
            -v --tb=short

      # ── Operational tests ──────────────────────────────────────────────
      - name: "Operational tests: refresh & scheduled download"
        run: |
          python -m pytest \
            tests/test_pipeline_group/test_refresh_workflow.py \
            tests/test_downloader_group/test_scheduled_download.py \
            -v --tb=short

      # ── GUI tracker tests (tkinter StringVar deallocator fix) ──────────
      - name: "GUI tracker tests: unit (no display)"
        run: |
          pytest tests/test_downloader_group/test_gui_tracker.py -v --tb=short \
            -k "not test_no_deallocator_error_on_close"

      - name: "GUI tracker test: integration (Xvfb headless display)"
        run: |
          xvfb-run --auto-servernum \
            pytest tests/test_downloader_group/test_gui_tracker.py::test_no_deallocator_error_on_close \
              -v --tb=short

      # ── Custom optimization runner + benchmarks ────────────────────────
      - name: Run optimization tests
        run: |
          python scripts/run_optimization_tests.py --verbose

      - name: Run optimization benchmarks
        run: |
          python scripts/run_optimization_tests.py --benchmark

      # ── Git workflow tests ────────────────────────────────────────────
      - name: "Git workflow & repo hygiene tests"
        run: |
          python -m pytest tests/test_git_workflow.py -v --tb=short

      # ── Smoke test: verify all key modules import ──────────────────────
      - name: Verify no broken imports
        run: |
          python -c "
          import dod_budget_downloader
          import search_budget
          import validate_budget_db
          import build_budget_db
          import downloader
          import pipeline
          print('All modules import successfully')
          "

      # ── Coverage report ────────────────────────────────────────────────
      - name: Generate coverage report
        if: always()
        run: |
          python -m pytest tests/ \
            --ignore=tests/test_downloader_group/test_gui_tracker.py \
            --ignore=tests/optimization_validation \
            --cov=api --cov=utils --cov=downloader --cov=pipeline \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=80 \
            -q --tb=no 2>/dev/null || true

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: coverage.xml
          retention-days: 7

      # ── Performance profiling ──────────────────────────────────────────
      - name: Run performance profiling
        run: python scripts/profile_queries.py --json
        continue-on-error: true

      - name: Upload profiling report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: profiling-${{ matrix.python-version }}
          path: profile_report.json
          retention-days: 7

      - name: Performance summary
        if: always()
        run: |
          if [ -f profile_report.json ]; then
            echo "## Performance Profiling Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Query | Time (ms) | Threshold (ms) | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-----------|----------------|--------|" >> $GITHUB_STEP_SUMMARY
            python -c "
          import json, sys
          try:
              with open('profile_report.json') as f:
                  data = json.load(f)
              for key, ms in data.get('timings', {}).items():
                  threshold = data.get('thresholds', {}).get(key, 500)
                  status = 'PASS' if ms <= threshold else 'FAIL'
                  print(f'| {key} | {ms:.0f} | {threshold} | {status} |')
          except Exception as e:
              print(f'Error reading profile: {e}', file=sys.stderr)
          " >> $GITHUB_STEP_SUMMARY
          fi

  # Docker build validation
  docker-build:
    name: "Docker Build Validation"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t dod-budget-test .

      - name: Validate Docker image imports
        run: |
          docker run --rm dod-budget-test python -c "
          from api.app import create_app
          import downloader
          import pipeline
          print('All Docker imports OK')
          "

name: Optimization Tests

on:
  push:
    branches: [ main, develop, "claude/**" ]
  pull_request:
    branches: [ main, develop ]

jobs:
  optimization-tests:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies (tkinter + Xvfb for GUI tests)
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y python3-tk xvfb

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest requests beautifulsoup4 openpyxl pdfplumber fpdf2

    # ── Custom optimization test runner ────────────────────────────────────
    - name: Run optimization tests
      run: |
        python scripts/run_optimization_tests.py --verbose

    - name: Run optimization benchmarks
      run: |
        python scripts/run_optimization_tests.py --benchmark

    # ── Unit tests: utilities (correctness) ───────────────────────────────
    - name: "Unit tests: utils/common.py"
      run: pytest tests/test_common_utils.py -v --tb=short

    - name: "Unit tests: utils/strings.py edge cases"
      run: pytest tests/test_strings_edge_cases.py -v --tb=short

    - name: "Unit tests: utils/patterns.py"
      run: pytest tests/test_patterns.py -v --tb=short

    - name: "Unit tests: utils/formatting.py"
      run: pytest tests/test_formatting.py -v --tb=short

    # ── Unit tests: exhibit catalog and audit ─────────────────────────────
    - name: "Unit tests: exhibit catalog"
      run: pytest tests/test_exhibit_catalog.py -v --tb=short

    - name: "Unit tests: exhibit audit"
      run: pytest tests/test_exhibit_audit.py -v --tb=short

    # ── Unit tests: query builders ────────────────────────────────────────
    - name: "Unit tests: query builders"
      run: pytest tests/test_query_builders.py -v --tb=short

    # ── Pre-commit quality checks ─────────────────────────────────────────
    - name: "Pre-commit quality checks"
      run: pytest tests/test_precommit_checks.py -v --tb=short

    # ── DB and parsing unit tests ─────────────────────────────────────────
    - name: "Unit tests: parsing and column detection"
      run: pytest tests/test_parsing.py -v --tb=short

    - name: "Unit tests: search FTS5 sanitization"
      run: pytest tests/test_search.py -v --tb=short

    - name: "Unit tests: checkpoint / resume"
      run: pytest tests/test_checkpoint.py -v --tb=short

    - name: "Unit tests: validation checks"
      run: |
        pytest tests/test_validation.py tests/test_validate_budget_db.py -v --tb=short

    # ── Build integration tests ───────────────────────────────────────────
    - name: "Integration tests: build_database phases"
      run: pytest tests/test_build_integration.py -v --tb=short

    # ── Full pipeline integration tests ───────────────────────────────────
    - name: "Integration tests: full ingest pipeline"
      continue-on-error: true
      run: pytest tests/test_pipeline.py -v --tb=short

    # ── Optimization regression + performance benchmarks ──────────────────
    - name: "Optimization regression + benchmarks"
      run: pytest tests/test_optimizations.py -v --tb=short

    # ── GUI tracker tests (tkinter StringVar deallocator fix) ─────────────
    - name: "GUI tracker tests: unit (no display)"
      run: |
        pytest tests/test_gui_tracker.py -v --tb=short \
          -k "not test_no_deallocator_error_on_close"

    - name: "GUI tracker test: integration (Xvfb headless display)"
      run: |
        xvfb-run --auto-servernum \
          pytest tests/test_gui_tracker.py::test_no_deallocator_error_on_close \
            -v --tb=short

    # ── Smoke test: verify all key modules import ─────────────────────────
    - name: Verify no broken imports
      run: |
        python -c "
        import dod_budget_downloader
        import search_budget
        import validate_budget_db
        import build_budget_db
        print('All modules import successfully')
        "

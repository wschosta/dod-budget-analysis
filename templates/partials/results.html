<!-- DONE [Group: LION] LION-003: Loading skeleton animation for HTMX requests -->
<!-- DONE [Group: LION] LION-004: "No results" empty state with clear-filters action -->
{# FIX-005: Added FY25 total and FY26 total columns.
   FIX-007: Added source file column. #}

{# LION-003: Skeleton rows shown during HTMX loading (hidden by default, shown via .htmx-request) #}
<div class="skeleton-loading" role="status" aria-live="polite" aria-label="Loading results">
  <div class="skeleton-row"></div>
  <div class="skeleton-row"></div>
  <div class="skeleton-row"></div>
  <div class="skeleton-row"></div>
  <div class="skeleton-row"></div>
  <span class="sr-only">Loading results...</span>
</div>

{% if items %}

{# FE-003: Active filter chips #}
{% if filters is defined %}
{% set active = [] %}
{% if filters.q %}{% set _ = active.append(("q", "Keyword", filters.q)) %}{% endif %}
{% for fy in filters.fiscal_year %}{% set _ = active.append(("fiscal_year", "FY", fy)) %}{% endfor %}
{% for svc in filters.service %}{% set _ = active.append(("service", "Service", svc)) %}{% endfor %}
{% for et in filters.exhibit_type %}{% set _ = active.append(("exhibit_type", "Exhibit", et)) %}{% endfor %}
{% for ac in filters.appropriation_code %}{% set _ = active.append(("appropriation_code", "Approp.", ac)) %}{% endfor %}
{% if filters.min_amount %}{% set _ = active.append(("min_amount", "Min $K", filters.min_amount)) %}{% endif %}
{% if filters.max_amount %}{% set _ = active.append(("max_amount", "Max $K", filters.max_amount)) %}{% endif %}
{% if active %}
<div class="active-filters" aria-label="Active filters">
  {% for param, label, value in active %}
  {% set new_qs = request.query_params | remove_filter_param(param, value) %}
  <span class="filter-chip">
    <span>{{ label }}: {{ value }}</span>
    {# FIX-016: Fallback href points to / (not /partials/) for non-JS browsers #}
    <a class="remove"
       href="/{% if new_qs %}?{{ new_qs }}{% endif %}"
       hx-get="/partials/results{% if new_qs %}?{{ new_qs }}{% endif %}"
       hx-target="#results-container"
       hx-push-url="true"
       aria-label="Remove {{ label }}: {{ value }} filter"
       title="Remove filter">×</a>
  </span>
  {% endfor %}
</div>
{% endif %}
{% endif %}

<div class="results-panel">
  <div class="results-header">
    <span class="results-count">
      {{ "{:,}".format(total) }} result{{ "s" if total != 1 }} — page {{ page }} of {{ total_pages }}
      <span style="font-size:.75rem;color:var(--text-secondary)">(showing {{ items|length }})</span>
    </span>

    {# Column toggles (3.A4-b) — FIX-005: added FY25 total, FY26 total; FIX-007: added source #}
    <div class="col-toggles" id="col-toggles">
      <button class="col-toggle active" data-col="org"      onclick="toggleCol(this,'col-org')">Service</button>
      <button class="col-toggle active" data-col="fy"       onclick="toggleCol(this,'col-fy')">FY</button>
      <button class="col-toggle active" data-col="exhibit"  onclick="toggleCol(this,'col-exhibit')">Exhibit</button>
      <button class="col-toggle active" data-col="account"  onclick="toggleCol(this,'col-account')">Account</button>
      <button class="col-toggle active" data-col="pe"       onclick="toggleCol(this,'col-pe')">PE#</button>
      <button class="col-toggle active" data-col="fy24"     onclick="toggleCol(this,'col-fy24')">FY24 Act.</button>
      <button class="col-toggle active" data-col="fy25"     onclick="toggleCol(this,'col-fy25')">FY25 Enact.</button>
      <button class="col-toggle"        data-col="fy25tot"  onclick="toggleCol(this,'col-fy25tot')">FY25 Total</button>
      <button class="col-toggle active" data-col="fy26"     onclick="toggleCol(this,'col-fy26')">FY26 Req.</button>
      <button class="col-toggle"        data-col="fy26tot"  onclick="toggleCol(this,'col-fy26tot')">FY26 Total</button>
      <button class="col-toggle"        data-col="source"   onclick="toggleCol(this,'col-source')">Source</button>
    </div>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th {% if sort_by == "line_item_title" %}aria-sort="{{ 'ascending' if sort_dir == 'asc' else 'descending' }}"{% endif %}>
            {% set next_dir = "desc" if sort_by == "line_item_title" and sort_dir == "asc" else "asc" %}
            <a hx-get="/partials/results" hx-target="#results-container"
               hx-push-url="true"
               hx-vals='{"sort_by":"line_item_title","sort_dir":"{{ next_dir }}","page":"1"}'
               hx-include="#filter-form">
              Program / Line Item
              {% if sort_by == "line_item_title" %}<span class="sort-icon">{{ "▲" if sort_dir == "asc" else "▼" }}</span>{% endif %}
            </a>
          </th>
          <th class="col-org" {% if sort_by == "organization_name" %}aria-sort="{{ 'ascending' if sort_dir == 'asc' else 'descending' }}"{% endif %}>
            <a hx-get="/partials/results" hx-target="#results-container"
               hx-push-url="true"
               hx-vals='{"sort_by":"organization_name","sort_dir":"{% if sort_by == "organization_name" and sort_dir == "asc" %}desc{% else %}asc{% endif %}","page":"1"}'
               hx-include="#filter-form">
              Service
              {% if sort_by == "organization_name" %}<span class="sort-icon">{{ "▲" if sort_dir == "asc" else "▼" }}</span>{% endif %}
            </a>
          </th>
          <th class="col-fy" data-tooltip="Fiscal year: Oct 1 – Sep 30">FY</th>
          <th class="col-exhibit" data-tooltip="Budget exhibit type (R-2, P-5, O-1, etc.)">Exhibit</th>
          <th class="col-account" data-tooltip="Appropriation account code">Account</th>
          <th class="col-pe" data-tooltip="Program Element number — unique identifier for each R&amp;D program">PE #</th>
          <th class="col-fy24 td-amount" data-tooltip="FY2024 actual expenditure in thousands of dollars ($K). Actual = amounts obligated by end of fiscal year.">
            <a hx-get="/partials/results" hx-target="#results-container"
               hx-push-url="true"
               hx-vals='{"sort_by":"amount_fy2024_actual","sort_dir":"{% if sort_by == "amount_fy2024_actual" and sort_dir == "desc" %}asc{% else %}desc{% endif %}","page":"1"}'
               hx-include="#filter-form">
              FY24 Actual ($K)
              {% if sort_by == "amount_fy2024_actual" %}<span class="sort-icon">{{ "▲" if sort_dir == "asc" else "▼" }}</span>{% endif %}
            </a>
          </th>
          <th class="col-fy25 td-amount" {% if sort_by == "amount_fy2025_enacted" %}aria-sort="{{ 'ascending' if sort_dir == 'asc' else 'descending' }}"{% endif %}
              data-tooltip="FY2025 enacted amount in thousands of dollars ($K). Enacted = signed into law by Congress.">
            <a hx-get="/partials/results" hx-target="#results-container"
               hx-push-url="true"
               hx-vals='{"sort_by":"amount_fy2025_enacted","sort_dir":"{% if sort_by == "amount_fy2025_enacted" and sort_dir == "desc" %}asc{% else %}desc{% endif %}","page":"1"}'
               hx-include="#filter-form">
              FY25 Enacted ($K)
              {% if sort_by == "amount_fy2025_enacted" %}<span class="sort-icon">{{ "▲" if sort_dir == "asc" else "▼" }}</span>{% endif %}
            </a>
          </th>
          <th class="col-fy25tot td-amount" style="display:none" data-tooltip="FY2025 total amount ($K) including supplementals.">FY25 Total ($K)</th>
          <th class="col-fy26 td-amount" data-tooltip="FY2026 budget request in thousands of dollars ($K). Request = President's budget submission to Congress.">
            <a hx-get="/partials/results" hx-target="#results-container"
               hx-push-url="true"
               hx-vals='{"sort_by":"amount_fy2026_request","sort_dir":"{% if sort_by == "amount_fy2026_request" and sort_dir == "desc" %}asc{% else %}desc{% endif %}","page":"1"}'
               hx-include="#filter-form">
              FY26 Request ($K)
              {% if sort_by == "amount_fy2026_request" %}<span class="sort-icon">{{ "▲" if sort_dir == "asc" else "▼" }}</span>{% endif %}
            </a>
          </th>
          <th class="col-fy26tot td-amount" style="display:none" data-tooltip="FY2026 total amount ($K) including reconciliation adjustments.">FY26 Total ($K)</th>
          <th class="col-source" style="display:none" data-tooltip="Source file from which this budget line was extracted.">Source</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        {# FIX-020: tabindex + keyboard handler for accessibility #}
        <tr hx-get="/partials/detail/{{ item.id }}"
            hx-target="#detail-container"
            hx-swap="innerHTML"
            tabindex="0"
            onclick="selectRow(this)"
            onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectRow(this);htmx.trigger(this,'click')}"
            role="row">
          <td>
            <div style="font-weight:600;font-size:.88rem">
              {{ item.line_item_title or item.account_title or "—" }}
            </div>
            {% if item.budget_activity_title %}
            <div style="font-size:.78rem;color:var(--text-secondary)">{{ item.budget_activity_title }}</div>
            {% endif %}
          </td>
          <td class="col-org td-org">{{ item.organization_name or "—" }}</td>
          <td class="col-fy">{{ item.fiscal_year or "—" }}</td>
          <td class="col-exhibit">
            {% if item.exhibit_type %}
            <span class="badge">{{ item.exhibit_type | upper }}</span>
            {% else %}—{% endif %}
          </td>
          <td class="col-account" style="font-size:.8rem">{{ item.account or "—" }}</td>
          <td class="col-pe" style="font-size:.8rem;font-family:monospace">{{ item.pe_number or "—" }}</td>
          <td class="col-fy24 td-amount">{{ item.amount_fy2024_actual | fmt_amount if item.amount_fy2024_actual is not none else "—" }}</td>
          <td class="col-fy25 td-amount">{{ item.amount_fy2025_enacted | fmt_amount if item.amount_fy2025_enacted is not none else "—" }}</td>
          <td class="col-fy25tot td-amount" style="display:none">{{ item.amount_fy2025_total | fmt_amount if item.amount_fy2025_total is not none else "—" }}</td>
          <td class="col-fy26 td-amount">{{ item.amount_fy2026_request | fmt_amount if item.amount_fy2026_request is not none else "—" }}</td>
          <td class="col-fy26tot td-amount" style="display:none">{{ item.amount_fy2026_total | fmt_amount if item.amount_fy2026_total is not none else "—" }}</td>
          <td class="col-source" style="display:none;font-size:.75rem;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="{{ item.source_file or '' }}">{{ item.source_file or "—" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# FE-010: Page-size selector + Pagination (3.A4-a) #}
  <div class="pagination">
    <label style="font-size:.8rem;color:var(--clr-gray-700);display:flex;align-items:center;gap:.25rem">
      Rows:
      <select id="page-size-select"
              onchange="setPageSize(this.value)"
              style="padding:.2rem .4rem;border-radius:4px;border:1px solid var(--clr-gray-200);font-size:.8rem">
        {% for ps in [10, 25, 50, 100] %}
        <option value="{{ ps }}" {% if ps == page_size %}selected{% endif %}>{{ ps }}</option>
        {% endfor %}
      </select>
    </label>

    {% if total_pages > 1 %}
    {% if page > 1 %}
    <button class="page-btn"
            hx-get="/partials/results" hx-target="#results-container"
            hx-push-url="true"
            hx-vals='{"page":"{{ page - 1 }}","page_size":"{{ page_size }}","sort_by":"{{ sort_by }}","sort_dir":"{{ sort_dir }}"}'
            hx-include="#filter-form">‹ Prev</button>
    {% endif %}

    {% for p in range([1, page - 2]|max, [total_pages + 1, page + 3]|min) %}
    <button class="page-btn {{ 'active' if p == page }}"
            hx-get="/partials/results" hx-target="#results-container"
            hx-push-url="true"
            hx-vals='{"page":"{{ p }}","page_size":"{{ page_size }}","sort_by":"{{ sort_by }}","sort_dir":"{{ sort_dir }}"}'
            hx-include="#filter-form">{{ p }}</button>
    {% endfor %}

    {% if page < total_pages %}
    <button class="page-btn"
            hx-get="/partials/results" hx-target="#results-container"
            hx-push-url="true"
            hx-vals='{"page":"{{ page + 1 }}","page_size":"{{ page_size }}","sort_by":"{{ sort_by }}","sort_dir":"{{ sort_dir }}"}'
            hx-include="#filter-form">Next ›</button>
    {% endif %}
    {% endif %}
  </div>
</div>

{% else %}
{# LION-004: Enhanced empty state with clear-filters action #}
<div class="results-panel">
  <div class="empty-state">
    <div class="empty-state-icon" aria-hidden="true">&#128269;</div>
    <p><strong>No budget items match your filters.</strong></p>
    <p style="font-size:.85rem">Try broadening your search or clearing some filters.</p>
    <div style="margin-top:1rem">
      <a href="/"
         hx-get="/partials/results"
         hx-target="#results-container"
         hx-push-url="/"
         class="btn btn-primary btn-sm">Clear all filters</a>
    </div>
  </div>
</div>
{% endif %}

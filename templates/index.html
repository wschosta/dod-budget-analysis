{#
──────────────────────────────────────────────────────────────────────────────
Frontend TODOs for this template (Step 3.A — UI Design & Core Features)
──────────────────────────────────────────────────────────────────────────────

TODO 3.A3-c / FE-001 [Group: LION] [Complexity: LOW] [Tokens: ~1500] [User: NO]
    Add amount range filters (min/max) to the filter sidebar.
    The wireframe (docs/UI_WIREFRAMES.md) shows Min/Max amount inputs but they
    are not yet implemented. Steps:
      1. Add two <input type="number"> fields for min_amount and max_amount
         below the exhibit type filter
      2. Include them in the hx-get/hx-include form submission
      3. Update _parse_filters() in api/routes/frontend.py to read them
      4. Update _query_results() to add WHERE clauses for amount range
      5. Add data-tooltip explaining "Amount in thousands of dollars ($K)"
    Acceptance: Users can filter budget lines by dollar amount range.

TODO 3.A3-d / FE-002 [Group: LION] [Complexity: LOW] [Tokens: ~1500] [User: NO]
    Add appropriation filter dropdown to the filter sidebar.
    The API supports appropriation_code filtering but the UI doesn't expose it.
    Steps:
      1. Add a <select multiple> for appropriation codes
      2. Populate from a new _get_appropriations(conn) helper in frontend.py
      3. Include in form submission and _parse_filters()
      4. Add data-tooltip: "Appropriation 'color of money' — e.g., RDT&E,
         Procurement, O&M"
    Acceptance: Appropriation filter appears and narrows results.

TODO 3.A3-e / FE-003 [Group: LION] [Complexity: LOW] [Tokens: ~1000] [User: NO]
    Add "active filter chips" above the results table.
    Show which filters are currently applied as dismissible chips/tags so users
    can see at a glance what's filtering their results and remove individual
    filters by clicking the X on each chip.
    Steps:
      1. Add a <div class="active-filters"> between the form and results
      2. In results.html partial, render a chip for each non-empty filter
      3. Each chip links to the same page with that filter removed
      4. Style chips in main.css (.filter-chip class)
    Acceptance: Active filters are visible and individually removable.
#}
{% extends "base.html" %}

{% block title %}Search — DoD Budget Explorer{% endblock %}

{% block content %}
<div class="search-layout">

  {# ── Filter sidebar (3.A3-a) ─────────────────────────────────────────── #}
  <aside class="filter-panel">
    <h2>Filters</h2>
    <form id="filter-form"
          hx-get="/partials/results"
          hx-target="#results-container"
          hx-trigger="change, search"
          hx-push-url="true"
          hx-indicator="#loading-indicator">

      <div class="filter-group">
        <label for="q" data-tooltip="Search program names, line item titles, and PDF text using full-text search (FTS5). Use quotes for exact phrases: &quot;hypersonic missile&quot;">Keyword Search</label>
        <input type="text" id="q" name="q"
               value="{{ filters.q }}"
               placeholder="missile, cyber, procurement…"
               hx-get="/partials/results"
               hx-trigger="keyup changed delay:400ms"
               hx-target="#results-container"
               hx-push-url="true"
               hx-include="#filter-form">
      </div>

      <div class="filter-group">
        <label for="fiscal_year" data-tooltip="DoD fiscal year runs Oct 1 – Sep 30. FY2026 = Oct 2025 – Sep 2026. Select multiple years with Ctrl+click (Windows) or Cmd+click (Mac).">Fiscal Year</label>
        <select id="fiscal_year" name="fiscal_year" multiple>
          {% for fy in fiscal_years %}
          <option value="{{ fy.fiscal_year }}"
                  {% if fy.fiscal_year in filters.fiscal_year %}selected{% endif %}>
            {{ fy.fiscal_year }} ({{ "{:,}".format(fy.row_count) }} rows)
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group">
        <label for="service" data-tooltip="Military service or defense agency submitting the budget justification. Includes Army, Navy, Air Force, Space Force, Marine Corps, and Defense-Wide agencies.">Service / Agency</label>
        <select id="service" name="service" multiple>
          {% for svc in services %}
          <option value="{{ svc.code }}"
                  {% if svc.code in filters.service %}selected{% endif %}>
            {{ svc.code }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group">
        <label for="exhibit_type" data-tooltip="Budget exhibit format. R-2: RDT&amp;E program details. P-5: procurement details. O-1: operation &amp; maintenance. P-1/R-1: summary rolls. C-1: construction. M-1: military personnel.">Exhibit Type</label>
        <select id="exhibit_type" name="exhibit_type" multiple>
          {% for et in exhibit_types %}
          <option value="{{ et.code }}"
                  {% if et.code in filters.exhibit_type %}selected{% endif %}>
            {{ et.code }} — {{ et.display_name }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-actions">
        <button type="submit" class="btn btn-primary btn-sm">Apply</button>
        <a href="/" class="btn btn-secondary btn-sm">Reset</a>
      </div>
    </form>

    {# Download modal trigger (3.A5-a) #}
    <hr style="margin: 1rem 0; border-color: var(--clr-gray-200);">
    <button class="btn btn-secondary btn-sm" style="width:100%"
            onclick="document.getElementById('dl-modal').classList.add('open')">
      ↓ Download Results
    </button>
  </aside>

  {# ── Results area ─────────────────────────────────────────────────────── #}
  <section>
    <div id="loading-indicator" class="htmx-indicator" style="margin-bottom:.5rem">
      <span class="spinner"></span> Loading…
    </div>

    <div id="results-container">
      {% include "partials/results.html" %}
    </div>
  </section>

</div>

{# ── Detail panel (3.A6-a) ─────────────────────────────────────────────────── #}
<div id="detail-container"></div>

{# ── Download modal (3.A5-a) ───────────────────────────────────────────────── #}
<div id="dl-modal" class="modal-backdrop"
     onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal">
    <h3>Download Budget Lines</h3>
    <p style="font-size:.85rem;color:#555;margin-bottom:.75rem">
      Downloads apply the current filters (up to 50,000 rows).
    </p>
    <div style="display:flex;gap:.5rem;flex-direction:column">
      <a id="dl-csv" href="#" class="btn btn-primary" download>
        ↓ Download CSV
      </a>
      <a id="dl-json" href="#" class="btn btn-secondary" download>
        ↓ Download NDJSON
      </a>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary btn-sm"
              onclick="document.getElementById('dl-modal').classList.remove('open')">
        Close
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/app.js"></script>
{% endblock %}

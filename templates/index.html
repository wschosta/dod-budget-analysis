{% extends "base.html" %}

{% block title %}Search — DoD Budget Explorer{% endblock %}

{% block content %}
<div class="search-layout">

  {# ── Filter sidebar (3.A3-a) ─────────────────────────────────────────── #}
  <aside class="filter-panel">
    <h2>Filters</h2>
    <form id="filter-form"
          role="search"
          aria-label="Budget data filters"
          hx-get="/partials/results"
          hx-target="#results-container"
          hx-trigger="change, search"
          hx-push-url="true"
          hx-indicator="#loading-indicator">

      <div class="filter-group">
        <label for="q" data-tooltip="Search program names, line item titles, and PDF text using full-text search (FTS5). Use quotes for exact phrases: &quot;hypersonic missile&quot;">Keyword Search</label>
        <input type="text" id="q" name="q"
               value="{{ filters.q }}"
               placeholder="missile, cyber, procurement…"
               hx-get="/partials/results"
               hx-trigger="keyup changed delay:400ms"
               hx-target="#results-container"
               hx-push-url="true"
               hx-include="#filter-form">
      </div>

      <div class="filter-group">
        <label for="fiscal_year" data-tooltip="DoD fiscal year runs Oct 1 – Sep 30. FY2026 = Oct 2025 – Sep 2026. Select multiple years with Ctrl+click (Windows) or Cmd+click (Mac).">Fiscal Year</label>
        <select id="fiscal_year" name="fiscal_year" multiple>
          {% for fy in fiscal_years %}
          <option value="{{ fy.fiscal_year }}"
                  {% if fy.fiscal_year in filters.fiscal_year %}selected{% endif %}>
            {{ fy.fiscal_year }} ({{ "{:,}".format(fy.row_count) }} rows)
          </option>
          {% endfor %}
        </select>
      </div>

      {# FIX-002: Service dropdown now uses deduplicated values from budget_lines #}
      <div class="filter-group">
        <label for="service" data-tooltip="Military service or defense agency submitting the budget justification. Includes Army, Navy, Air Force, Space Force, Marine Corps, and Defense-Wide agencies.">Service / Agency</label>
        <select id="service" name="service" multiple>
          {% for svc in services %}
          <option value="{{ svc.code }}"
                  {% if svc.code in filters.service %}selected{% endif %}>
            {{ svc.full_name if svc.full_name != svc.code else svc.code }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group">
        <label for="exhibit_type" data-tooltip="Budget exhibit format. R-2: RDT&amp;E program details. P-5: procurement details. O-1: operation &amp; maintenance. P-1/R-1: summary rolls. C-1: construction. M-1: military personnel.">Exhibit Type</label>
        <select id="exhibit_type" name="exhibit_type" multiple>
          {% for et in exhibit_types %}
          <option value="{{ et.code }}"
                  {% if et.code in filters.exhibit_type %}selected{% endif %}>
            {{ et.code }} — {{ et.display_name }}
          </option>
          {% endfor %}
        </select>
      </div>

      {# FE-001: Amount range filters #}
      <div class="filter-group">
        <label data-tooltip="Amount in thousands of dollars ($K). Filter lines where the FY2026 request falls within this range.">Amount Range ($K)</label>
        <div style="display:flex;gap:.4rem;align-items:center">
          <input type="number" id="min_amount" name="min_amount"
                 value="{{ filters.min_amount }}"
                 placeholder="Min"
                 style="width:50%"
                 min="0">
          <span style="font-size:.8rem;color:var(--clr-gray-700)">–</span>
          <input type="number" id="max_amount" name="max_amount"
                 value="{{ filters.max_amount }}"
                 placeholder="Max"
                 style="width:50%"
                 min="0">
        </div>
      </div>

      {# FE-002: Appropriation filter #}
      <div class="filter-group">
        <label for="appropriation_code" data-tooltip="Appropriation 'color of money' — e.g., RDT&amp;E, Procurement, O&amp;M. Select multiple with Ctrl+click (Windows) or Cmd+click (Mac).">Appropriation</label>
        <select id="appropriation_code" name="appropriation_code" multiple>
          {% for ap in appropriations %}
          <option value="{{ ap.code }}"
                  {% if ap.code in filters.appropriation_code %}selected{% endif %}>
            {{ ap.code }}{% if ap.title %} — {{ ap.title }}{% endif %}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-actions">
        <button type="submit" class="btn btn-primary btn-sm">Apply</button>
        <a href="/" class="btn btn-secondary btn-sm">Reset</a>
        {# LION-007: Share button — copies filtered URL to clipboard #}
        <button type="button" id="share-btn" class="btn btn-secondary btn-sm share-btn"
                onclick="copyShareURL()" aria-label="Copy shareable URL">&#128279; Share</button>
        <button type="button" class="btn btn-secondary btn-sm"
                onclick="var name=prompt('Name this search:');if(name)saveCurrentSearch(name)"
                aria-label="Save current search">&#9733; Save</button>
      </div>
    </form>

    {# Download modal trigger (3.A5-a) #}
    <hr style="margin: 1rem 0; border-color: var(--clr-gray-200);">
    <button class="btn btn-secondary btn-sm" style="width:100%"
            onclick="document.getElementById('dl-modal').classList.add('open')">
      &darr; Download Results
    </button>

    {# Saved searches #}
    <div style="margin-top:.75rem">
      <h3 style="font-size:.8rem;text-transform:uppercase;letter-spacing:.04em;color:var(--clr-gray-700);margin-bottom:.25rem">
        Saved Searches
      </h3>
      <div id="saved-searches-list"></div>
    </div>
  </aside>

  {# ── Results area ─────────────────────────────────────────────────────── #}
  <section>
    {# LION-008: Print header (visible only when printing) #}
    <div class="print-header">
      <h2>DoD Budget Explorer</h2>
      <div class="print-meta">
        {% if filters.q %}Keyword: "{{ filters.q }}" | {% endif %}
        {% if filters.fiscal_year %}FY: {{ filters.fiscal_year | join(', ') }} | {% endif %}
        {% if filters.service %}Service: {{ filters.service | join(', ') }} | {% endif %}
        {% if filters.exhibit_type %}Exhibit: {{ filters.exhibit_type | join(', ') }} | {% endif %}
        Printed <script>document.write(new Date().toLocaleDateString())</script>
      </div>
    </div>

    {# LION-008: Print button #}
    <div style="display:flex;justify-content:flex-end;margin-bottom:.5rem">
      <button class="btn btn-secondary btn-sm print-btn" onclick="window.print()">Print Results</button>
    </div>

    {# FE-005: ARIA live region for loading status #}
    <div id="loading-indicator" class="htmx-indicator" style="margin-bottom:.5rem"
         role="status" aria-live="polite" aria-label="Loading results">
      <span class="spinner"></span> Loading…
    </div>

    <div id="results-container"
         aria-live="polite"
         aria-atomic="false"
         aria-label="Search results">
      {% include "partials/results.html" %}
    </div>
  </section>

</div>

{# ── Detail panel (3.A6-a) ─────────────────────────────────────────────────── #}
<div id="detail-container"></div>

{# ── Download modal (3.A5-a) ───────────────────────────────────────────────── #}
<div id="dl-modal" class="modal-backdrop"
     onclick="if(event.target===this)this.classList.remove('open')"
     role="dialog"
     aria-modal="true"
     aria-labelledby="dl-modal-title">
  <div class="modal">
    <h3 id="dl-modal-title">Download Budget Lines</h3>
    <p id="dl-modal-count" style="font-size:.85rem;color:#555;margin-bottom:.75rem">
      Downloads apply the current filters (up to 50,000 rows).
    </p>
    <div style="display:flex;gap:.5rem;flex-direction:column">
      <a id="dl-csv" href="#" class="btn btn-primary" download>
        ↓ Download CSV
      </a>
      <a id="dl-json" href="#" class="btn btn-secondary" download>
        ↓ Download NDJSON
      </a>
      <a id="dl-xlsx" href="#" class="btn btn-secondary" download>
        ↓ Download Excel (.xlsx)
      </a>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary btn-sm"
              onclick="document.getElementById('dl-modal').classList.remove('open')">
        Close
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/app.js"></script>
{% endblock %}

{#
──────────────────────────────────────────────────────────────────────────────
Charts page TODOs (Step 3.B — Data Visualization)
──────────────────────────────────────────────────────────────────────────────

TODO 3.B1-b / VIZ-001 [Group: LION] [Complexity: MEDIUM] [Tokens: ~2500] [User: NO]
    Make chart FY columns dynamic instead of hardcoded FY2024/2025/2026.
    Currently the JS references hardcoded column names like total_fy2026_request.
    When FY2027 data arrives, all charts break. Steps:
      1. Add a /api/v1/reference/amount-columns endpoint that returns the list
         of amount column names present in budget_lines schema
      2. In loadCharts(), fetch this list first and use it to build chart labels
      3. Update aggregation endpoint to return dynamic column sums
      4. Update chart dataset construction to iterate over dynamic FY list
    Acceptance: Charts auto-adapt when new FY columns are added to the schema.

TODO 3.B1-c / VIZ-002 [Group: LION] [Complexity: LOW] [Tokens: ~1500] [User: NO]
    Add error handling and loading indicators to chart API calls.
    Currently if an API call fails, the chart silently shows nothing. Steps:
      1. Wrap each fetch() in try/catch
      2. Show a user-friendly error message in the chart card on failure
      3. Add a loading spinner to each chart-card while data loads
      4. Disable FY selector during loading to prevent double-fetches
    Acceptance: Network errors show message instead of blank charts.

TODO 3.B2-b / VIZ-003 [Group: LION] [Complexity: LOW] [Tokens: ~1500] [User: NO]
    Add service filter to charts page.
    Currently charts show all services. Add filter controls to scope charts
    to specific services. Steps:
      1. Add service multi-select dropdown next to the FY selector
      2. Pass selected services as query parameter to aggregation API
      3. Update loadCharts() to include service filter in fetch URLs
    Acceptance: Users can filter charts by service/agency.

TODO 3.B3-b / VIZ-004 [Group: LION] [Complexity: MEDIUM] [Tokens: ~2000] [User: NO]
    Add print-friendly styles for the charts page.
    Charts should be printable for reports and briefings. Steps:
      1. Add @media print {} rules in main.css
      2. Hide navigation, filters, and interactive controls in print
      3. Ensure charts render at full width in print layout
      4. Add a "Print Charts" button that triggers window.print()
    Acceptance: Ctrl+P produces a clean, readable chart printout.

TODO 3.B4-a / VIZ-005 [Group: LION] [Complexity: MEDIUM] [Tokens: ~3000] [User: NO]
    Add a "Budget Comparison" interactive chart.
    Allow users to select two programs or services and overlay their budget
    trends on a single chart for visual comparison. Steps:
      1. Add a comparison mode with two entity selectors
      2. Fetch aggregation data for both entities
      3. Render overlapping bar or line chart using Chart.js
      4. Include percent-change annotations between years
    Acceptance: Users can visually compare two budget items side-by-side.
#}
{% extends "base.html" %}

{% block title %}Charts — DoD Budget Explorer{% endblock %}

{% block content %}
<h2 style="margin-bottom:1rem">Budget Visualizations</h2>

<div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:1rem">
  <label style="font-size:.85rem">Fiscal Year:
    <select id="chart-fy" onchange="loadCharts()" style="margin-left:.25rem;padding:.3rem .5rem;border-radius:4px;border:1px solid #ddd">
      {% for fy in fiscal_years %}
      <option value="{{ fy.fiscal_year }}">{{ fy.fiscal_year }}</option>
      {% endfor %}
    </select>
  </label>
</div>

<div class="charts-grid">

  {# 3.B2-a: Service comparison bar chart #}
  <div class="chart-card">
    <h3>FY26 Request by Service ($K)</h3>
    <canvas id="chart-service" height="200"></canvas>
  </div>

  {# 3.B1-a: Year-over-year trend #}
  <div class="chart-card">
    <h3>Year-over-Year Totals by Exhibit Type</h3>
    <canvas id="chart-yoy" height="200"></canvas>
  </div>

  {# 3.B3-a: Top-N budget items #}
  <div class="chart-card" style="grid-column: 1 / -1">
    <h3>Top 10 Budget Line Items — FY26 Request ($K)</h3>
    <canvas id="chart-topn" height="120"></canvas>
  </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
const API = '/api/v1';

// Colour palette
const COLORS = [
  '#2563eb','#16a34a','#d97706','#dc2626','#7c3aed',
  '#0891b2','#c2410c','#065f46','#92400e','#1e1b4b',
];

let chartService, chartYoY, chartTopN;

async function loadCharts() {
  const fy = document.getElementById('chart-fy').value;

  // ── Service bar chart (3.B2-a) ──────────────────────────────────────────
  const svcResp = await fetch(`${API}/aggregations?group_by=service&fiscal_year=${fy}`);
  const svcData = await svcResp.json();
  const svcRows = svcData.rows.filter(r => r.total_fy2026_request);
  const svcLabels = svcRows.map(r => r.group_value || 'Unknown');
  const svcAmts   = svcRows.map(r => (r.total_fy2026_request || 0) / 1000);  // $M

  if (chartService) chartService.destroy();
  chartService = new Chart(document.getElementById('chart-service'), {
    type: 'bar',
    data: {
      labels: svcLabels,
      datasets: [{
        label: 'FY26 Request ($M)',
        data: svcAmts,
        backgroundColor: COLORS,
        borderRadius: 4,
      }],
    },
    options: {
      indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { callback: v => '$' + v.toLocaleString() + 'M' } },
      },
    },
  });

  // ── Year-over-year chart (3.B1-a) ──────────────────────────────────────
  const yoyResp = await fetch(`${API}/aggregations?group_by=fiscal_year`);
  const yoyData = await yoyResp.json();
  const yoyLabels = yoyData.rows.map(r => r.group_value || '?');
  const yoyFy24   = yoyData.rows.map(r => (r.total_fy2024_actual  || 0) / 1000);
  const yoyFy25   = yoyData.rows.map(r => (r.total_fy2025_enacted || 0) / 1000);
  const yoyFy26   = yoyData.rows.map(r => (r.total_fy2026_request || 0) / 1000);

  if (chartYoY) chartYoY.destroy();
  chartYoY = new Chart(document.getElementById('chart-yoy'), {
    type: 'bar',
    data: {
      labels: yoyLabels,
      datasets: [
        { label: 'FY24 Actual',   data: yoyFy24, backgroundColor: '#cbd5e1', borderRadius: 3 },
        { label: 'FY25 Enacted',  data: yoyFy25, backgroundColor: '#2563eb', borderRadius: 3 },
        { label: 'FY26 Request',  data: yoyFy26, backgroundColor: '#16a34a', borderRadius: 3 },
      ],
    },
    options: {
      plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } } },
      scales: { x: { stacked: false }, y: { ticks: { callback: v => '$' + v.toLocaleString() + 'M' } } },
    },
  });

  // ── Top-N chart (3.B3-a) ────────────────────────────────────────────────
  const topResp = await fetch(
    `${API}/budget-lines?sort_by=amount_fy2026_request&sort_dir=desc&limit=10&fiscal_year=${fy}`
  );
  const topData = await topResp.json();
  const topLabels = topData.items.map(r => {
    const title = r.line_item_title || r.account_title || 'Unknown';
    const org   = r.organization_name ? ` (${r.organization_name})` : '';
    return title.length > 40 ? title.slice(0, 38) + '…' + org : title + org;
  });
  const topAmts = topData.items.map(r => (r.amount_fy2026_request || 0) / 1000);

  if (chartTopN) chartTopN.destroy();
  chartTopN = new Chart(document.getElementById('chart-topn'), {
    type: 'bar',
    data: {
      labels: topLabels,
      datasets: [{
        label: 'FY26 Request ($M)',
        data: topAmts,
        backgroundColor: COLORS,
        borderRadius: 4,
      }],
    },
    options: {
      indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { callback: v => '$' + v.toLocaleString() + 'M' } },
      },
    },
  });
}

// Initial load
loadCharts();
</script>
{% endblock %}

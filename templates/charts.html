{% extends "base.html" %}

{% block title %}Charts â€” DoD Budget Explorer{% endblock %}

{% block content %}
<h2 style="margin-bottom:1rem">Budget Visualizations</h2>

<div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:1rem;align-items:center">
  {# FY selector #}
  <label style="font-size:.85rem">Fiscal Year:
    <select id="chart-fy" onchange="loadCharts()" style="margin-left:.25rem;padding:.3rem .5rem;border-radius:4px;border:1px solid var(--border-color)">
      {% for fy in fiscal_years %}
      <option value="{{ fy.fiscal_year }}">{{ fy.fiscal_year }}</option>
      {% endfor %}
    </select>
  </label>

  {# VIZ-003: Service filter #}
  <label style="font-size:.85rem">Service:
    <select id="chart-service-filter" multiple
            style="margin-left:.25rem;padding:.3rem .5rem;border-radius:4px;border:1px solid var(--border-color);height:80px"
            onchange="loadCharts()">
    </select>
  </label>

  <!-- DONE [Group: LION] LION-006: Chart export buttons added per card below -->

  {# VIZ-004: Print button #}
  <button class="btn btn-secondary btn-sm print-btn" onclick="window.print()" style="margin-left:auto">
    ðŸ–¨ Print Charts
  </button>
</div>

{# VIZ-002: Loading indicator #}
<div id="charts-loading" style="display:none;text-align:center;padding:2rem">
  <span class="spinner"></span> Loading chartsâ€¦
</div>

<div id="charts-grid-wrapper">
<div class="charts-grid">

  {# 3.B2-a: Service comparison bar chart #}
  <div class="chart-card" id="card-service">
    <h3>FY Request by Service ($M)</h3>
    <div id="err-service" style="display:none" class="empty-state" role="alert"></div>
    <canvas id="chart-service" height="200"></canvas>
    <button class="btn btn-secondary btn-sm chart-export-btn" onclick="downloadChartAsPNG('chart-service','service-chart.png')">Download as PNG</button>
  </div>

  {# 3.B1-a: Year-over-year trend #}
  <div class="chart-card" id="card-yoy">
    <h3>Year-over-Year Totals by Exhibit Type</h3>
    <div id="err-yoy" style="display:none" class="empty-state" role="alert"></div>
    <canvas id="chart-yoy" height="200"></canvas>
    <button class="btn btn-secondary btn-sm chart-export-btn" onclick="downloadChartAsPNG('chart-yoy','yoy-chart.png')">Download as PNG</button>
  </div>

  {# 3.B3-a: Top-N budget items #}
  <div class="chart-card" id="card-topn" style="grid-column: 1 / -1">
    <h3>Top 10 Budget Line Items â€” FY Request ($M)</h3>
    <div id="err-topn" style="display:none" class="empty-state" role="alert"></div>
    <canvas id="chart-topn" height="120"></canvas>
    <button class="btn btn-secondary btn-sm chart-export-btn" onclick="downloadChartAsPNG('chart-topn','top10-chart.png')">Download as PNG</button>
  </div>

  {# VIZ-005: Budget comparison chart #}
  <div class="chart-card" id="card-compare" style="grid-column: 1 / -1">
    <h3>Budget Comparison</h3>
    <div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:.75rem;align-items:center">
      <label style="font-size:.85rem">Entity A:
        <select id="compare-a" onchange="loadComparison()"
                style="margin-left:.25rem;padding:.3rem .5rem;border-radius:4px;border:1px solid var(--border-color)">
          <option value="">â€” Select service â€”</option>
        </select>
      </label>
      <label style="font-size:.85rem">Entity B:
        <select id="compare-b" onchange="loadComparison()"
                style="margin-left:.25rem;padding:.3rem .5rem;border-radius:4px;border:1px solid var(--border-color)">
          <option value="">â€” Select service â€”</option>
        </select>
      </label>
    </div>
    <div id="err-compare" style="display:none" class="empty-state" role="alert"></div>
    <canvas id="chart-compare" height="120"></canvas>
    <button class="btn btn-secondary btn-sm chart-export-btn" onclick="downloadChartAsPNG('chart-compare','comparison-chart.png')">Download as PNG</button>
  </div>

  {# Treemap: Hierarchical budget breakdown #}
  <div class="chart-card" id="card-treemap" style="grid-column: 1 / -1">
    <h3>Budget Hierarchy: Service &gt; Appropriation</h3>
    <div id="err-treemap" style="display:none" class="empty-state" role="alert"></div>
    <canvas id="chart-treemap" height="300"></canvas>
    <button class="btn btn-secondary btn-sm chart-export-btn" onclick="downloadChartAsPNG('chart-treemap','treemap.png')">Download as PNG</button>
  </div>

  {# Appropriation breakdown doughnut #}
  <div class="chart-card" id="card-approp-pie">
    <h3>Appropriation Breakdown</h3>
    <div id="err-approp-pie" style="display:none" class="empty-state" role="alert"></div>
    <canvas id="chart-approp-pie" height="250"></canvas>
    <button class="btn btn-secondary btn-sm chart-export-btn" onclick="downloadChartAsPNG('chart-approp-pie','appropriation-pie.png')">Download as PNG</button>
  </div>

  {# YoY delta by service #}
  <div class="chart-card" id="card-delta">
    <h3>Year-over-Year Change by Service (%)</h3>
    <div id="err-delta" style="display:none" class="empty-state" role="alert"></div>
    <canvas id="chart-delta" height="200"></canvas>
    <button class="btn btn-secondary btn-sm chart-export-btn" onclick="downloadChartAsPNG('chart-delta','yoy-delta.png')">Download as PNG</button>
  </div>

</div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- FALCON-11: Chart JS extracted to external file -->
<script src="/static/js/app.js"></script>
<script src="/static/js/charts.js"></script>
{% endblock %}

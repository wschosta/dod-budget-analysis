{% extends "base.html" %}

{% block title %}Program Explorer — DoD Budget Explorer{% endblock %}

{% block content %}
{# FALCON-12: Programs page intro with enrichment status #}
<div class="programs-intro">
  <h2>Program Explorer</h2>
  <p class="programs-subtitle">
    Browse and search Program Elements (PEs) across all military services and defense agencies.
    Each PE card links to detailed funding history, trend charts, and narrative descriptions.
  </p>
  <div class="programs-stats" id="programs-stats">
    <!-- Populated by JS from /api/v1/metadata -->
  </div>
</div>

<div class="programs-layout">

  {# FALCON-14: Mobile filter drawer toggle #}
  <button type="button" class="filter-drawer-toggle" id="pe-filter-drawer-toggle"
          aria-expanded="false" aria-controls="pe-filter-panel"
          onclick="toggleFilterDrawer('pe-filter-panel','pe-filter-drawer-toggle')">
    Filters &amp; Search Options
  </button>

  <aside class="filter-panel" id="pe-filter-panel" aria-label="Program filters">
    <h2>Program Filters</h2>
    <form id="pe-filter-form"
          role="search"
          aria-label="Program filters"
          hx-get="/partials/program-list"
          hx-target="#pe-results"
          hx-trigger="change, search"
          hx-indicator="#pe-loading">

      <div class="filter-group">
        <label for="pe-search">Search Programs</label>
        <input type="text" id="pe-search" name="q"
               placeholder="F-35, cyber, missile…"
               hx-get="/partials/program-list"
               hx-trigger="keyup changed delay:400ms"
               hx-target="#pe-results"
               hx-include="#pe-filter-form">
      </div>

      {# FIX-008: Service dropdown now uses deduplicated values from budget_lines #}
      <div class="filter-group">
        <label for="pe-service">Service / Agency</label>
        <select id="pe-service" name="service">
          <option value="">All Services</option>
          {% for svc in services %}
          <option value="{{ svc.code }}">{{ svc.full_name if svc.full_name != svc.code else svc.code }}</option>
          {% endfor %}
        </select>
      </div>

      {% if tags %}
      <div class="filter-group">
        <label for="pe-tag">Tags</label>
        <select id="pe-tag" name="tag" multiple>
          {% for t in tags %}
          <option value="{{ t.tag }}">{{ t.tag }} ({{ t.pe_count }})</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}

      <div class="filter-actions">
        <button type="submit" class="btn btn-primary btn-sm">Apply</button>
        <a href="/programs" class="btn btn-secondary btn-sm">Reset</a>
      </div>
    </form>
  </aside>

  <section aria-label="Program list">
    {% if not has_pe_data %}
    <div class="empty-state" style="background:var(--bg-surface);border:1px solid var(--border-color);border-radius:var(--radius);padding:2rem">
      <div class="empty-state-icon" aria-hidden="true">&#128203;</div>
      <p><strong>Program enrichment data not available.</strong></p>
      <p style="font-size:.85rem;max-width:480px;margin:0 auto">
        The Program Explorer requires enriched program element (PE) data.
        Run <code>python enrich_budget_db.py</code> to generate PE metadata,
        tags, and narrative descriptions from the budget database.
      </p>
      <div style="margin-top:1rem">
        <a href="/" class="btn btn-primary btn-sm">Search budget lines instead</a>
      </div>
    </div>
    {% else %}
    <div id="pe-loading" class="htmx-indicator" style="margin-bottom:.5rem">
      <span class="spinner"></span> Loading programs&hellip;
    </div>
    <div id="pe-results" aria-live="polite">
      {% include "partials/program-list.html" %}
    </div>
    {% endif %}
  </section>

</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/app.js"></script>
{% endblock %}

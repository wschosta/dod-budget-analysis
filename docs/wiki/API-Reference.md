# API Reference

REST API documentation for the DoD Budget Analysis database.

> **Interactive docs** are auto-generated by FastAPI and available at
> `http://localhost:8000/docs` (Swagger UI) and `/redoc` (ReDoc) when the
> server is running.

---

## Base URL

```
http://localhost:8000        # development
https://<your-host>          # production
```

All data endpoints are under the `/api/v1` prefix.

---

## Authentication

No authentication required.  The API is publicly readable.

**Rate limits** are enforced per IP address (fixed 60-second window):

| Endpoint | Limit |
|----------|-------|
| `GET /api/v1/search` | 60 requests / minute |
| `GET /api/v1/download` | 10 requests / minute |
| All other endpoints | 120 requests / minute |

When a limit is exceeded the server returns `429 Too Many Requests` with a
`Retry-After: 60` header.

---

## Common Response Fields

All amounts are in **thousands of dollars ($K)** unless `amount_unit` says
otherwise.  DoD fiscal years run **October 1 – September 30**
(FY2026 = Oct 2025 – Sep 2026).

---

## Error Response Format

All errors return JSON with a consistent structure:

```json
{
  "error": "Human-readable message",
  "detail": "Specific reason or field name",
  "status_code": 400
}
```

| Status | Meaning |
|--------|---------|
| `400` | Bad request (invalid parameter value) |
| `404` | Resource not found |
| `422` | Validation error (missing required parameter) |
| `429` | Rate limit exceeded |
| `500` | Internal server error |
| `503` | Database unavailable |

---

## Endpoints

---

### `GET /api/v1/search`

Full-text search across budget line items and PDF page text using SQLite
FTS5 with BM25 relevance ranking.

#### Parameters

| Name | Type | Required | Default | Description |
|------|------|----------|---------|-------------|
| `q` | string | **yes** | — | Search query string (min length 1). Use quotes for exact phrases: `"hypersonic missile"`. |
| `type` | string | no | `both` | Result type filter: `excel`, `pdf`, or `both`. |
| `limit` | integer | no | `20` | Max results per type (1–100). |
| `offset` | integer | no | `0` | Pagination offset. |

#### Response Schema

```json
{
  "query": "Apache",
  "total": 3,
  "limit": 20,
  "offset": 0,
  "results": [
    {
      "result_type": "budget_line",
      "id": 1042,
      "source_file": "fy2026_army_p1.xlsx",
      "snippet": "...procurement of Apache AH-64E attack helicopters...",
      "score": -4.821,
      "data": {
        "organization_name": "Army",
        "fiscal_year": "FY 2026",
        "exhibit_type": "p1",
        "line_item_title": "Apache AH-64",
        "amount_fy2026_request": 1250000.0
      }
    }
  ]
}
```

> Note: `score` is a BM25 score — **more negative = more relevant**.

#### Example

```bash
# Search for "Apache" in all sources
curl "http://localhost:8000/api/v1/search?q=Apache"

# Search only Excel data, return up to 5 results
curl "http://localhost:8000/api/v1/search?q=hypersonic&type=excel&limit=5"

# Exact phrase search
curl "http://localhost:8000/api/v1/search?q=%22F-35+development%22"

# Paginate: skip first 20 results
curl "http://localhost:8000/api/v1/search?q=missile&limit=20&offset=20"
```

---

### `GET /api/v1/budget-lines`

List, filter, sort, and paginate budget line items.

#### Parameters

| Name | Type | Required | Default | Description |
|------|------|----------|---------|-------------|
| `fiscal_year` | string (multi) | no | — | Filter by fiscal year(s). Repeat for multiple: `?fiscal_year=FY+2025&fiscal_year=FY+2026` |
| `service` | string (multi) | no | — | Filter by service/agency name (e.g., `Army`, `Navy`). |
| `exhibit_type` | string (multi) | no | — | Filter by exhibit type code (e.g., `p1`, `r1`, `r2`, `p5`). |
| `pe_number` | string (multi) | no | — | Filter by program element number(s). |
| `appropriation_code` | string (multi) | no | — | Filter by appropriation code. |
| `sort_by` | string | no | `id` | Column to sort by (e.g., `amount_fy2026_request`, `organization_name`). |
| `sort_dir` | string | no | `asc` | Sort direction: `asc` or `desc`. |
| `limit` | integer | no | `25` | Max items per page (1–500). |
| `offset` | integer | no | `0` | Pagination offset. |

#### Response Schema

```json
{
  "total": 14823,
  "limit": 25,
  "offset": 0,
  "items": [
    {
      "id": 1,
      "source_file": "fy2026_army_p1.xlsx",
      "exhibit_type": "p1",
      "fiscal_year": "FY 2026",
      "organization_name": "Army",
      "line_item_title": "Apache AH-64",
      "amount_fy2024_actual": 1100000.0,
      "amount_fy2025_enacted": 1150000.0,
      "amount_fy2026_request": 1250000.0
    }
  ]
}
```

#### Example

```bash
# All Army budget lines for FY2026, sorted by amount descending
curl "http://localhost:8000/api/v1/budget-lines?service=Army&fiscal_year=FY+2026&sort_by=amount_fy2026_request&sort_dir=desc"

# RDT&E lines, page 2 (25 per page)
curl "http://localhost:8000/api/v1/budget-lines?exhibit_type=r1&limit=25&offset=25"

# Navy and Marine Corps lines
curl "http://localhost:8000/api/v1/budget-lines?service=Navy&service=Marine+Corps"
```

---

### `GET /api/v1/budget-lines/{id}`

Retrieve a single budget line by its ID with full field detail.

#### Path Parameters

| Name | Type | Required | Description |
|------|------|----------|-------------|
| `id` | integer | **yes** | Budget line row ID |

#### Response Schema

The response extends the list item with additional detail fields:

```json
{
  "id": 1042,
  "source_file": "fy2026_army_p1.xlsx",
  "exhibit_type": "p1",
  "fiscal_year": "FY 2026",
  "organization_name": "Army",
  "line_item_title": "Apache AH-64",
  "pe_number": "0205228A",
  "appropriation_code": "Procurement",
  "appropriation_title": "Aircraft Procurement, Army",
  "currency_year": "FY2026",
  "amount_unit": "$K",
  "amount_fy2024_actual": 1100000.0,
  "amount_fy2025_enacted": 1150000.0,
  "amount_fy2025_supplemental": 0.0,
  "amount_fy2025_total": 1150000.0,
  "amount_fy2026_request": 1250000.0,
  "amount_fy2026_reconciliation": 0.0,
  "amount_fy2026_total": 1250000.0,
  "quantity_fy2024": 24.0,
  "quantity_fy2025": 24.0,
  "quantity_fy2026_request": 24.0,
  "quantity_fy2026_total": 24.0
}
```

Returns `404` if the ID does not exist.

#### Example

```bash
curl "http://localhost:8000/api/v1/budget-lines/1042"
```

---

### `GET /api/v1/aggregations`

GROUP BY summaries of budget amounts for charts and dashboards.

#### Parameters

| Name | Type | Required | Default | Description |
|------|------|----------|---------|-------------|
| `group_by` | string | **yes** | — | Dimension to group by: `service`, `fiscal_year`, or `exhibit_type`. |
| `fiscal_year` | string (multi) | no | — | Pre-filter by fiscal year(s) before aggregating. |
| `service` | string (multi) | no | — | Pre-filter by service name(s). |
| `exhibit_type` | string (multi) | no | — | Pre-filter by exhibit type(s). |

#### Response Schema

```json
{
  "group_by": "service",
  "rows": [
    {
      "group_value": "Army",
      "row_count": 3842,
      "total_fy2024_actual": 48200000.0,
      "total_fy2025_enacted": 51300000.0,
      "total_fy2026_request": 54700000.0
    },
    {
      "group_value": null,
      "row_count": 12,
      "total_fy2026_request": 8500.0
    }
  ]
}
```

> `group_value` may be `null` for rows where the grouped column is NULL.

Returns `400` if `group_by` is not one of the allowed values.

#### Example

```bash
# Spending by service for all years
curl "http://localhost:8000/api/v1/aggregations?group_by=service"

# Year-over-year totals for RDT&E exhibits only
curl "http://localhost:8000/api/v1/aggregations?group_by=fiscal_year&exhibit_type=r1&exhibit_type=r2"

# Spending by exhibit type for the Army in FY2026
curl "http://localhost:8000/api/v1/aggregations?group_by=exhibit_type&service=Army&fiscal_year=FY+2026"
```

---

### `GET /api/v1/download`

Bulk export of filtered budget lines as streaming CSV or newline-delimited JSON.

#### Parameters

| Name | Type | Required | Default | Description |
|------|------|----------|---------|-------------|
| `fmt` | string | no | `csv` | Output format: `csv` or `json` (newline-delimited JSON, one record per line). |
| `fiscal_year` | string (multi) | no | — | Filter by fiscal year(s). |
| `service` | string (multi) | no | — | Filter by service name(s). |
| `exhibit_type` | string (multi) | no | — | Filter by exhibit type(s). |
| `pe_number` | string (multi) | no | — | Filter by PE number(s). |
| `limit` | integer | no | `10000` | Max rows to export (1–100000). |

#### Response

- **CSV** (`fmt=csv`): `Content-Type: text/csv; charset=utf-8`
  Streams rows with a header line.  Filename: `dod_budget.csv`.

- **JSON** (`fmt=json`): `Content-Type: application/x-ndjson`
  One JSON object per line (newline-delimited JSON / NDJSON format).
  Filename: `dod_budget.ndjson`.

Both formats stream the response; large exports do not buffer in memory.

**Rate limit**: 10 requests / minute.

#### Example

```bash
# Download all Army FY2026 data as CSV
curl -o army_fy2026.csv \
  "http://localhost:8000/api/v1/download?fmt=csv&service=Army&fiscal_year=FY+2026"

# Download top 500 rows as newline-delimited JSON
curl "http://localhost:8000/api/v1/download?fmt=json&limit=500"

# Download all RDT&E data
curl -o rdte.csv \
  "http://localhost:8000/api/v1/download?fmt=csv&exhibit_type=r1&exhibit_type=r2&limit=100000"
```

---

### `GET /api/v1/reference/services`

List all distinct services / agencies in the database.

#### Response Schema

```json
[
  {
    "code": "Army",
    "full_name": "Department of the Army",
    "category": "Military Department"
  },
  {
    "code": "Navy",
    "full_name": "Department of the Navy",
    "category": "Military Department"
  }
]
```

#### Example

```bash
curl "http://localhost:8000/api/v1/reference/services"
```

---

### `GET /api/v1/reference/exhibit-types`

List all distinct exhibit types with descriptions.

#### Response Schema

```json
[
  {
    "code": "r2",
    "display_name": "RDT&E Program Summary",
    "exhibit_class": "rdte",
    "description": "Research, Development, Test & Evaluation program summary"
  },
  {
    "code": "p5",
    "display_name": "Procurement Program",
    "exhibit_class": "procurement",
    "description": null
  }
]
```

#### Example

```bash
curl "http://localhost:8000/api/v1/reference/exhibit-types"
```

---

### `GET /api/v1/reference/fiscal-years`

List all distinct fiscal years with row counts.

#### Response Schema

```json
[
  { "fiscal_year": "FY 2024", "row_count": 4821 },
  { "fiscal_year": "FY 2025", "row_count": 5103 },
  { "fiscal_year": "FY 2026", "row_count": 4899 }
]
```

#### Example

```bash
curl "http://localhost:8000/api/v1/reference/fiscal-years"
```

---

### `GET /health`

Basic health check.  Returns `200 OK` if the API is running and can reach
the database; `503 Service Unavailable` otherwise.

#### Response Schema

**200 OK:**
```json
{
  "status": "ok",
  "database": "/app/dod_budget.sqlite",
  "budget_lines": 14823
}
```

**503 Service Unavailable:**
```json
{
  "status": "no_database",
  "database": "/app/dod_budget.sqlite"
}
```

#### Example

```bash
curl -sf http://localhost:8000/health && echo "healthy"
```

---

### `GET /health/detailed`

Detailed operational metrics for monitoring dashboards.  Counters reset on
process restart (stateless — no persistence).

#### Response Schema

```json
{
  "status": "ok",
  "uptime_seconds": 3621.4,
  "request_count": 8420,
  "error_count": 2,
  "db_size_bytes": 52428800,
  "budget_lines_count": 14823,
  "pdf_pages_count": 3201,
  "avg_response_time_ms": 12.4,
  "rate_limiter_stats": {
    "tracked_ips": 14,
    "blocked_requests": 3
  }
}
```

| Field | Description |
|-------|-------------|
| `uptime_seconds` | Seconds since the process started |
| `request_count` | Total requests handled (excluding rate-blocked) |
| `error_count` | Total 5xx responses served |
| `db_size_bytes` | Current database file size in bytes |
| `budget_lines_count` | Rows in the `budget_lines` table |
| `pdf_pages_count` | Rows in the `pdf_pages` table |
| `avg_response_time_ms` | Average response time for the last 100 requests |
| `rate_limiter_stats.tracked_ips` | Unique IPs with active rate-limit windows |
| `rate_limiter_stats.blocked_requests` | Total requests blocked since startup |

Returns `503` if the database is unavailable.

#### Example

```bash
curl -s http://localhost:8000/health/detailed | python3 -m json.tool
```

---

## Pagination

Paginated endpoints (`/api/v1/budget-lines`, `/api/v1/search`) use
`limit` and `offset` parameters:

```bash
# Page 1 (rows 1-25)
curl "http://localhost:8000/api/v1/budget-lines?limit=25&offset=0"

# Page 2 (rows 26-50)
curl "http://localhost:8000/api/v1/budget-lines?limit=25&offset=25"
```

The response always includes a `total` field with the full result count so
clients can compute the number of pages: `pages = ceil(total / limit)`.

---

## Security Headers

All responses include:

| Header | Value |
|--------|-------|
| `Content-Security-Policy` | `default-src 'self'; script-src 'self' unpkg.com cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self';` |
| `X-Content-Type-Options` | `nosniff` |
| `X-Frame-Options` | `DENY` |
